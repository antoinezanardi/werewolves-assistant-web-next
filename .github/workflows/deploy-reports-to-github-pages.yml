name: 游늼 Deploy Reports to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch reports to deploy'
        required: true
        default: 'main'

env:
  REPORTS_URL: https://antoinezanardi.github.io/werewolves-assistant-web-next/reports
  UNIT_TESTS_COVERAGE_REPORTS_PATH: tests/unit/coverage
  ACCEPTANCE_TESTS_REPORTS_PATH: tests/acceptance/reports
  STRYKER_REPORT_PATH: tests/stryker/coverage

jobs:
  format-branch-name:
    name: Format Branch Name for Reports 游꼒
    runs-on: ubuntu-latest
    steps:
      - name: Set branch name for reports in env 游꼒
        id: format-branch-name
        run: echo "BRANCH_NAME_FORMATTED_FOR_REPORTS=$(echo ${{ github.event.inputs.branch }} | sed 's/\//-/g')" >> "$GITHUB_OUTPUT"

    outputs:
      formatted-branch-for-reports: ${{ steps.format-branch-name.outputs.BRANCH_NAME_FORMATTED_FOR_REPORTS }}

  deploy-unit-tests-reports:
    name: Deploy Unit Tests Reports
    runs-on: ubuntu-latest
    needs: format-branch-name
    env:
      BRANCH_NAME_FORMATTED_FOR_REPORTS: ${{ needs.format-branch-name.outputs.formatted-branch-for-reports }}
    steps:
      - name: Checkout GitHub repository 游니
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0

      - name: Restore tests coverage from cache 游보
        uses: actions/cache/restore@v4
        id: cache-unit-tests-coverage
        with:
          path: tests/unit/coverage
          key: Linux-tests-unit-coverage-v3-ci/deploy-reports-on-dedicated-job-9f25cecb7b68a45bd1f4d89900f328c59599c1f4bac198e6564f1a2d6b836cad
          restore-keys: |
           Linux-tests-unit-coverage-v3-ci/deploy-reports-on-dedicated-job-9f25cecb7b68a45bd1f4d89900f328c59599c1f4bac198e6564f1a2d6b836cad

      - name: Save unit tests reports in GitHub Pages 游늼
        uses: PavanMudigonda/html-reporter-github-pages@v1.2
        if: steps.cache-unit-tests-coverage.outcome == 'success'
        with:
          test_results: ${{ env.UNIT_TESTS_COVERAGE_REPORTS_PATH }}
          report_url: ${{ env.REPORTS_URL }}
          keep_reports: 1
          gh_pages: gh_pages
          subfolder: reports
          tool_name: vitest
          workflow_name: coverage
          env: ${{ env.BRANCH_NAME_FORMATTED_FOR_REPORTS }}
          token: ${{ secrets.GH_PAGES_REPORTS_TOKEN }}

  deploy-acceptance-tests-reports:
    name: Deploy Acceptance Tests Reports
    runs-on: ubuntu-latest
    needs:
      - format-branch-name
      - deploy-unit-tests-reports
    env:
      BRANCH_NAME_FORMATTED_FOR_REPORTS: ${{ needs.format-branch-name.outputs.formatted-branch-for-reports }}
    steps:
      - name: Checkout GitHub repository 游니
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0

      - name: Restore E2E tests reports from cache 游보
        uses: actions/cache/restore@v4
        id: cache-e2e-tests-reports
        with:
          path: tests/acceptance/reports
          key: ${{ runner.os }}-tests-acceptance-reports-v3-${{ github.event.inputs.branch }}-
          restore-keys: |
            ${{ runner.os }}-tests-acceptance-reports-v3-${{ github.event.inputs.branch }}-

      - name: Save acceptance tests reports in GitHub Pages 游늼
        uses: PavanMudigonda/html-reporter-github-pages@v1.2
        with:
          test_results: ${{ env.ACCEPTANCE_TESTS_REPORTS_PATH }}
          report_url: ${{ env.REPORTS_URL }}
          keep_reports: 1
          gh_pages: gh_pages
          subfolder: reports
          tool_name: cucumber
          workflow_name: report
          env: ${{ env.BRANCH_NAME_FORMATTED_FOR_REPORTS }}
          token: ${{ secrets.GH_PAGES_REPORTS_TOKEN }}

  deploy-stryker-reports:
    name: Deploy Stryker Reports
    runs-on: ubuntu-latest
    needs:
      - format-branch-name
      - deploy-acceptance-tests-reports
    env:
      BRANCH_NAME_FORMATTED_FOR_REPORTS: ${{ needs.format-branch-name.outputs.formatted-branch-for-reports }}
    steps:
      - name: Checkout GitHub repository 游니
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0

      - name: Restore stryker report from cache 游보
        uses: actions/cache/restore@v4
        id: cache-stryker-reports
        with:
          path: tests/stryker/coverage
          key: ${{ runner.os }}-tests-stryker-coverage-v3-${{ github.event.inputs.branch }}-
          restore-keys: |
            ${{ runner.os }}-tests-stryker-coverage-v3-${{ github.event.inputs.branch }}-

      - name: Save stryker reports in GitHub Pages 游늼
        uses: PavanMudigonda/html-reporter-github-pages@v1.2
        with:
          test_results: ${{ env.STRYKER_REPORT_PATH }}
          report_url: ${{ env.REPORTS_URL }}
          keep_reports: 1
          gh_pages: gh_pages
          subfolder: reports
          tool_name: stryker
          workflow_name: coverage
          env: ${{ env.BRANCH_NAME_FORMATTED_FOR_REPORTS }}
          token: ${{ secrets.GH_PAGES_REPORTS_TOKEN }}